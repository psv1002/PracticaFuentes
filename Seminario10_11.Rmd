---
title: "Seminario Fuentes"
author:
  - "Aitana Crespo Ferrero" 
  - "Paula Santamaría Velasco" 
  - "Beatriz Alonso Martín"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduccion

## Objetivos
### Objetivo global 
El objetivo global de nuestro trabajo es analizar la relacion de antidepresivos/estimulantes con el número de defuncion por enfermedad.
Nuestros datos han sido extraídos desde www.datos.gob en formato .json:
- Numero de defunciones por enfermedad según sexo y comunidad autónoma.
- Porcentaje de medicamentos consumidos según sexo y comunidad autónoma.

### Objetivos especificos
- Analizar como afectan los antidepresivos/estimulantes al número de defunciones por demencia 
- Analizar como afectan los antidepresivos/estimulantes al número de defunciones por cáncer de páncreas
- Analizar como afectan los antidepresivos/estimulantes al número de defunciones por enfermedades isquémicas

## Medicamentos y enfermedades
### Antidepresivos/estimulantes
### Cáncer de páncreas
El cáncer de páncreas se produce por la formación incontrolada de células malignas cancerosas en los tejidos del páncreas, por lo que las celulas sanas de este, dejan de funcionar correctamente.
Síntomas:
- Ictericia
- Materia fecal de color claro
- Orina de color oscuro
- Pérdida de peso de razón desconocida
- Pérdida de apetito
- Dolor en el abdomen y espalda
- Sensación de mucho cansancio

### Enfermedades isquémicas
Las enfermedades isquémicas producen la reducción del flujo sanguíneo en los tejidos del cuerpo humano, es decir disminuye el nivel de nutrientes y oxígeno en las zonas afectadas. 
Síntomas:
- Dolor de cuello o de mandíbula
- Dolor de brazo o de hombro
- Sudoración
- Cansancio
- Dificultad para respirar
- Latido del corazón rápido
- Náuseas y vomitos

### Demencia 
La demencia es una enfermedad que se produce por daños a las celulas del cerebro.Esta lesión celular interfiere con la capacidad de las células cerebrales para comunicarse entre ellas. Cuando estas mismas no pueden comunicarse con normalidad, el pensamiento, el conportamiento y los sentimientos se ven afectados.
Los síntomas de la demencia varian mucho, pero normalmente se ven afetados las siguientes funciones mentales basicas:
-Memoria 
-Comunicación y lenguaje 
-Capacidad de concentrarse y prestar atencion razonamiento y jucio 
-Percepción visual 

## Importacion de datos
### Instalacion de liberias
```{r}
install.packages("rjson")
install.packages("stats")
install.packages("tidyjson", dependencies = TRUE)
```

### Importacion de librerias
```{r}
library(conflicted)
library(rjson)
library(tidyjson)
library(dplyr)
library(tidyverse)
```

INTENTO DE IMPORTACION DE DATOS EN JSON
```{r}
enfermedades <- fromJSON(file ="DATOS/enfermedades.json")
enfermedad_DF <- spread_all(enfermedades)
```

```{r}
library(dplyr)
medicamentos <- fromJSON(file ="DATOS/medicamentos_consumidos.json")
medicamentos_DF <- spread_all(medicamentos)

df <- medicamentos_DF%>%
  gather_object%>%
  select()
```

```{r}
library("dplyr")
summary(medicamentos_DF)
head(medicamentos_DF)
```

IMPORTACION DE DATOS EN EXCEL
```{r eval=FALSE}
library(readxl)
enfermedades2 <- read_excel("DATOS/enfermedades.xlsx")
medicamentos2 <- read_excel("DATOS/medicamentos_consumidos.xlsx")
```

Modificamos primero la tabla enfermedades 2
```{r eval=FALSE}
# Creamos una tabla Enfe igual que la tabla inicial pero a partir de la fila 7
Enfe <- enfermedades2%>%
  slice(.data = ., 7:nrow(enfermedades2))
```


```{r eval=FALSE}
head(Enfe)
```

Tabla: muertes por demencia en todas las comunidades(total, hombre y mujer)
```{r eval=FALSE}
# Creamos 4 vectores vacios
comunidades =c()
total = c()
mujer = c()
hombre = c()

# Recorremos la tabla Enfe entera y se accede a cada fila en la que ponga "Demencia"
# Añadimos al vector vacio "comunidades" las comunidades que hay en nuestra tabla inicial que se encuentran 21 filas antes que la fila "Demencia"
# Añadimos a los demas vectores los datos correspondientes que se encuentran en la 1, 2 o 3 filas siguientes que la fila de "Demencia"

for(i in 1:nrow(Enfe)){
    if(!is.na(Enfe$`Defunciones según causa de muerte. Avance enero-mayo 2020`[i]) && Enfe$`Defunciones según causa de muerte. Avance enero-mayo 2020`[i] == "Demencia"){
      comunidades <- append(comunidades,Enfe$`Defunciones según causa de muerte. Avance enero-mayo 2020`[i-21])
      total <- append(total,Enfe$...2[i+1])
      hombre <- append(hombre,Enfe$...2[i+2])
      mujer <-append(mujer,Enfe$...2[i+3])
  }
}

# Creamos un dataframe con los vectores creados anteriormente
muerteDemencia <- data.frame(
  Comunidades = comunidades,
  TotalDemencia = as.integer(total),
  HombreDemencia = as.integer(hombre),
  MujerDemencia = as.integer(mujer))
muerteDemencia
```

Tabla: muertes por cancer de pancreas en todas las comunidades(total, hombre y mujer)
```{r eval=FALSE}
totalCP = c()
mujerCP = c()
hombreCP = c()

for(i in 1:nrow(Enfe)){
    if(!is.na(Enfe$`Defunciones según causa de muerte. Avance enero-mayo 2020`[i]) && Enfe$`Defunciones según causa de muerte. Avance enero-mayo 2020`[i] == "Cáncer de páncreas"){
      totalCP <- append(totalCP,Enfe$...2[i+1])
      hombreCP <- append(hombreCP,Enfe$...2[i+2])
      mujerCP <-append(mujerCP,Enfe$...2[i+3])
  }
}

muerteCancerPancreas <- data.frame(
  Comunidades = comunidades,
  TotalCancerPancreas = as.integer(totalCP),
  HombreCancerPancreas = as.integer(hombreCP),
  MujerCancerPancreas = as.integer(mujerCP))
muerteCancerPancreas
```

Tabla: muertes por enfermedades isquémicas  en todas las comunidades(total, hombre y mujer)
```{r eval=FALSE}
# Creamos 4 vectores vacios
total_isq = c()
mujer_isq = c()
hombre_isq = c()

for(i in 1:nrow(Enfe)){
    if(!is.na(Enfe$`Defunciones según causa de muerte. Avance enero-mayo 2020`[i]) && Enfe$`Defunciones según causa de muerte. Avance enero-mayo 2020`[i] == "Enfermedades isquémicas del corazón"){
      total_isq <- append(total_isq,Enfe$...2[i+1])
      hombre_isq <- append(hombre_isq,Enfe$...2[i+2])
      mujer_isq <-append(mujer_isq,Enfe$...2[i+3])
  }
}

# Creamos un dataframe con los vectores creados anteriormente
muerteIsquemia <- data.frame(
  Comunidades = comunidades,
  TotalIsquemia = as.integer(total_isq),
  HombreIsquemia = as.integer(hombre_isq),
  MujerIsquemia = as.integer(mujer_isq))
muerteIsquemia



```



Modificamos la tabla medicamentos2
Tabla:Consumo de antidepresivos  en todas las comunidades(total, hombre y mujer)
```{r eval=FALSE}
medicamentosAntidepresivos<- data.frame(
  select(.data = medicamentos2,`Asistencia sanitaria: Cifras relativas`)%>%slice(9:28)%>%rename(Comunidades = `Asistencia sanitaria: Cifras relativas`),
  select(.data = medicamentos2,...39)%>%slice(9:28)%>%rename(TotalAntidepresivos =...39),
  select(.data = medicamentos2,...39)%>%slice(30:49)%>%rename(HombreAntidepresivos =...39),
  select(.data = medicamentos2,...39)%>%slice(51:70)%>%rename(MujerAntidepresivos =...39)
)
medicamentosAntidepresivos<-medicamentosAntidepresivos %>% 
  mutate(TotalAntidepresivos = as.double(TotalAntidepresivos)) %>% 
  mutate(HombreAntidepresivos = as.double(HombreAntidepresivos)) %>% 
  mutate(MujerAntidepresivos = as.double(MujerAntidepresivos))


```


Hacemos el left_join
Medicamentos antidepresivos con muertes por demencia 
```{r}
#columna comunidades en las dos tablas iguales para poder realizar el join 
for(i in 1:nrow(medicamentosAntidepresivos)){
  if(medicamentosAntidepresivos$Comunidades[i] != muerteDemencia$Comunidades[i]){
    medicamentosAntidepresivos$Comunidades[i]<- muerteDemencia$Comunidades[i]
  }
}

# Lo que falla es que las dos tablas que queremos juntar tienen distintos nombre de comunidades (unicamente cambian en un parentesis algunas) por eso aparecen NA
# Si hacemos un full_join vemos que aparecen los nombres de las mismas comunidades pero con un parentesis mas:
poblacionEspaña2020<-47329981
union <-full_join(x = medicamentosAntidepresivos, y = muerteDemencia, by = c("Comunidades")) %>%
  arrange(.data = ., TotalDemencia, TotalAntidepresivos)%>%#codigo nuevo Aitna apartir de aqui, antes hace el full join 
  summarise(Sexo = c("Hombres", "Mujeres", "Total"),
            Demencia = c(sum(HombreDemencia)*100/poblacionEspaña2020, sum(MujerDemencia)*100/poblacionEspaña2020, sum(TotalDemencia)*100/poblacionEspaña2020),
            Antidepresivos = c(mean(HombreAntidepresivos), mean(MujerAntidepresivos), mean(TotalAntidepresivos)))%>%
  pivot_longer(names_to = "condicion", values_to = "valores", cols = (Demencia:Antidepresivos))
union
grafica<-ggplot(union, aes(fill = condicion, y=valores, x=Sexo)) + 
    geom_bar(position="dodge", stat="identity")
grafica+facet_grid("condicion", scales = "free_y")


#union<-union %>% 
 # pivot_longer(names_to = "Sexo", values_to = "Valores", cols = c(HombreAntidepresivos:MujerAntidepresivos))
```

Medicamentos antidepresivos con muertes por cancer de pancreas 
```{r}
#columna comunidades en las dos tablas iguales para poder realizar el join 
for(i in 1:nrow(medicamentosAntidepresivos)){
  if(medicamentosAntidepresivos$Comunidades[i] != muerteCancerPancreas$Comunidades[i]){
    medicamentosAntidepresivos$Comunidades[i]<- muerteCancerPancreas$Comunidades[i]
  }
}

# Lo que falla es que las dos tablas que queremos juntar tienen distintos nombre de comunidades (unicamente cambian en un parentesis algunas) por eso aparecen NA
# Si hacemos un full_join vemos que aparecen los nombres de las mismas comunidades pero con un parentesis mas:

unionCP <-full_join(x = medicamentosAntidepresivos, y = muerteCancerPancreas, by = c("Comunidades")) %>%
  arrange(.data = ., TotalCancerPancreas, TotalAntidepresivos)

unionCP<-unionCP%>% 
  pivot_longer(names_to = "Sexo", values_to = "Valores", cols = c(HombreAntidepresivos:MujerAntidepresivos))
```


```{r}
#columna comunidades en las dos tablas iguales para poder realizar el join 
for(i in 1:nrow(medicamentosAntidepresivos)){
  if(medicamentosAntidepresivos$Comunidades[i] != muerteIsquemia$Comunidades[i]){
    medicamentosAntidepresivos$Comunidades[i]<- muerteIsquemia$Comunidades[i]
  }
}

# Lo que falla es que las dos tablas que queremos juntar tienen distintos nombre de comunidades (unicamente cambian en un parentesis algunas) por eso aparecen NA
# Si hacemos un full_join vemos que aparecen los nombres de las mismas comunidades pero con un parentesis mas:

unionIS <-full_join(x = medicamentosAntidepresivos, y = muerteIsquemia, by = c("Comunidades")) %>%
  arrange(.data = ., TotalIsquemia, TotalAntidepresivos)

#Pruebas
unionIS1<-unionIS%>% 
  pivot_longer(names_to = "Sexo", values_to = "Valores", cols = c(HombreIsquemia:MujerIsquemia))
unionIS1

unionIS2<-unionIS%>% 
  pivot_longer(names_to = "Sexo2", values_to = "Valores2", cols = c(HombreAntidepresivos:MujerAntidepresivos))
unionIS2

#Código original
unionIS<-unionIS%>% 
  pivot_longer(names_to = "Sexo", values_to = "Valores", cols = c(HombreAntidepresivos:MujerAntidepresivos))


```




## Gráficos
### Importación de librerias
```{r eval=FALSE}
library(ggplot2)
library(tidyverse)
```


```{r eval=FALSE}
grafico_MuertesDemencia <- ggplot(data = union, aes(x = TotalAntidepresivos, y = TotalDemencia)) +
  geom_point()+
  labs(x = "Porcentaje de antidepresivos consumidos", y = "Nº de defunciones por demencia", subtitle = "Relación de antidepresivos con muertes por demencia")

grafico_MuertesDemencia
```

```{r eval=FALSE}
grafico_MuertesIsquemia <- ggplot(data = tablaA, aes(x = AntidepresivosHombreMujer$Valores2  , y = AntidepresivosHombreMujer$TotalAntidepresivos)) +
  geom_point(aes(colour = factor(DATOOOS$Valores2)))+
  labs(x = "Porcentaje de antidepresivos consumidos por hombre y mujer", y = "Nº de defunciones por isquemia en hombres y mujeres", subtitle = "Relación de antidepresivos con muertes por isquemia")

grafico_MuertesIsquemia

```
Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

## Bibliografia
https://www.topdoctors.es/diccionario-medico/isquemia

https://www.cancer.gov/espanol/tipos/pancreas/paciente/tratamiento-pancreas-pdq

https://www.alz.org/alzheimer-demencia/que-es-la-demencia#S%C3%ADntomas

https://www.ine.es/daco/daco42/ecp/ecp0323.pdf
